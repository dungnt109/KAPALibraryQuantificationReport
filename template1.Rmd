```{r, echo=FALSE, warning = FALSE}

data <- read.csv(file_path, sep=",", header=FALSE)
file_name = paste(data[1, 2], data[1, 3], sep="")
file_name = gsub("_", "\\\\_", file_name)
run_started = data[5, 2]
run_ended = data[6, 2]
machine = data[11, 2]

if (machine == "CT019934"){
	machine = "CFX96 (1)"
} else if (machine == "CT020097"){
	machine = "CFX96 (2)"
}

path = sub("Run Information.*", "", file_path)

figure_path <- paste(path, "Amplification.png", sep="") 

standard_curve_path = paste(path, " Standard Curve Results.csv", sep="")

standard_curve_result = read.csv(standard_curve_path, sep=",", header=TRUE)

slope <-   sprintf("%#.1f", standard_curve_result$Slope)
reaction_efficiency <- round(standard_curve_result$Efficiency..)
r_2_value <- sprintf("%#.2f", standard_curve_result$R.2)   

if (round(standard_curve_result$Slope, digits=1) >= -3.6 && round(standard_curve_result$Slope, digits=1) <= -3.1){
	slope_status = "\\textcolor{darkgreen}{PASS}"
} else {
	slope_status = "\\textcolor{orange}{ALERT}"
}

if (reaction_efficiency >= 90 && reaction_efficiency <= 110){
	reaction_efficiency_status = "\\textcolor{darkgreen}{PASS}"
} else {
	reaction_efficiency_status = "\\textcolor{orange}{ALERT}"
}

if (round(standard_curve_result$R.2, digits=2) >= 0.99){
	r_2_status = "\\textcolor{darkgreen}{PASS}"
} else {
	r_2_status = "\\textcolor{orange}{ALERT}"
}



quantification_result_path = paste(path, " Quantification Cq Results.csv", sep="")

quantification_result = read.csv(quantification_result_path, sep=",", header=TRUE)

quantification_result = quantification_result[ , -c(1, 3, 4, 7, 9, 10, 12, 13, 14, 15, 16)]

quantification_result <- quantification_result[, c(1, 3, 2, 5, 4)]


colnames(quantification_result) <- c("Well", "Sample", "Type", "Given Concentration", "Ct Value")

B <- standard_curve_result$Y.Intercept 
M <- standard_curve_result$Slope

quantification_result <- quantification_result[order(quantification_result$Type), ]

quantification_result <- quantification_result[order(quantification_result$Type == "NTC"), ]

quantification_result <- quantification_result %>%
  group_by(Type) %>%
  mutate(delta = abs(max(`Ct Value`) - min(`Ct Value`))) %>%
  ungroup()

quantification_result <- quantification_result %>%
  group_by(Type) %>%
  mutate(delta = ifelse(row_number() == 1, sprintf("%#.2f", delta), "")) %>%
  ungroup()

quantification_result <- quantification_result %>%
  group_by(Type) %>%
  mutate(average = mean(`Ct Value`)) %>%
  ungroup()

quantification_result <- quantification_result %>%
  group_by(Type) %>%
  mutate(average = ifelse(row_number() == 1, sprintf("%#.2f", average), "")) %>%
  ungroup()

df <- quantification_result

df$val_num <- suppressWarnings(as.numeric(df$average))

# Create result column
df$result <- df$val_num

for (i in 1:(nrow(df))) {
  # Only process non-NA (non-empty) values
  if (!is.na(df$val_num[i])) {
    
    # Search for the next non-NA value
    j <- i + 1
    while (j <= nrow(df) && is.na(df$val_num[j])) {
      j <- j + 1
    }

    # If we found a valid next value, subtract
    if (j <= nrow(df)) {
      df$result[i] <- sprintf("%#.2f", df$val_num[j] - df$val_num[i])
    } else {
      df$result[i] <- ""
    }
  } else {
    df$result[i] <- ""
  }
}

df <- df %>% select(-val_num)

df <- df %>% select(-average)


quantification_result <- df 



#quantification_result <- quantification_result %>%
#  mutate(`Given Concentration` = ifelse(`Given Concentration` == "NaN", "", `Given Concentration`) )


quantification_result$concentration <- ifelse(quantification_result$`Ct Value` == "NaN", "", round( 10^((quantification_result$`Ct Value` - B) / M))) 

quantification_result$`Ct Value` = ifelse(quantification_result$`Ct Value` == "NaN", "", sprintf("%#.2f",quantification_result$`Ct Value`))


quantification_result$delta = ifelse(quantification_result$delta == "NaN",  "", quantification_result$delta)

quantification_result$`Given Concentration` = ifelse(quantification_result$`Given Concentration` == "NaN",  "", format(quantification_result$`Given Concentration`, scientific = FALSE))

quantification_result <- quantification_result[, c(1, 2, 3, 4, 8, 5, 6, 7)]

colnames <- c("\\makecell[l]{Well}", "\\makecell[l]{Sample}", "\\makecell[l]{Type}", "\\makecell[l]{Given\\\\Concentration}", "\\makecell[l]{Calculated\\\\Concentration}", "\\makecell[l]{Ct\\\\Value}", "\\makecell[l]{$\\Delta Ct$ of\\\\Replicates}", "\\makecell[l]{$\\Delta Ct$ of\\\\Averages}")

```
\textbf{\underline{Standard Curve (Set 1)}}

\textbf{Experiment Information}

\begin{tabular}{l l}
File name: &  `r file_name` \\
Run started & `r run_started` \\
Run ended & `r run_ended` \\
Machine used: & `r machine` \\
\end{tabular}

\textbf{Quantification Information}

\begin{tabular}{|c | c | c |}
\hline
Parameter & Results & QC Status \\
\hline
Threshold &       &     -    \\
Slope     &  `r slope`       &   `r slope_status`        \\
Reaction efficiency &  `r reaction_efficiency`  &  `r reaction_efficiency_status`      \\
$R^2$ Value   &   `r r_2_value`      &      `r r_2_status`     \\
\hline
\end{tabular} 

\textbf{Quantification Results} 

\begin{figure}[h]
    \centering
    \includegraphics[width=\textwidth]{`r figure_path`}
    \label{fig:yourlabel}
\end{figure}

```{r fig1, fig.align="center", echo = FALSE}

 
kbl(quantification_result,
    format = "latex",
    booktabs = TRUE,
    escape = FALSE,
    col.names = colnames,
    align = "l") %>%
  column_spec(1, width = "1cm") %>%
  column_spec(2, width = "4cm") 
 


```

\textbf{Quality Control (QC) Checklist}


\begin{tabularx}{\textwidth} {|c | X | c|}
\hline
\textbf{No.} & \textbf{Quality Control Criteria} & \textbf{QC Status} \\
\hline
1   & Slope between -3.1 and -3.6 &     `r slope_status`   \\
2   & Reaction Efficiency 90\%-110\% &  `r reaction_efficiency_status`     \\
3   & $R^2$ value: $\geq$0.99     &     `r r_2_status`  \\
4   & $\Delta$Ct of replicates within $\pm$1.5 & \\
5   & $\Delta$Ct of Average Ct between consecutive Standards: 3.1 to 3.6 & \\
6   & Lowest Ct of NTC $\geq$3.0 Ct from highest Ct of Standard 6       & \\
\hline
\multicolumn{2}{|l}{Overall QC Status}   & \\
\hline
\end{tabularx}
